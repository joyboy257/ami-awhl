{
    "name": "W-2: SERP Pipeline",
    "nodes": [
        {
            "parameters": {},
            "id": "w2-trigger-1",
            "name": "Manual Trigger",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                100,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "-- Get active queries to process (Tier A/B)\nSELECT sq.id, sq.vertical_id, sq.query_text, sq.geo, sq.intent_tag\nFROM wellness.search_queries sq\nWHERE sq.active = true\n  AND sq.priority_tier IN ('A', 'B')\n  AND NOT EXISTS (\n    SELECT 1 FROM wellness.serp_snapshots ss\n    WHERE ss.query_id = sq.id\n      AND ss.captured_at > NOW() - INTERVAL '24 hours'\n  )\nLIMIT 50;"
            },
            "id": "w2-get-queries",
            "name": "Get Queries",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                300,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "id": "w2-split",
            "name": "Split Queries",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                500,
                300
            ]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "https://serpapi.com/search.json",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpQueryAuth",
                "sendQuery": true,
                "queryParameters": {
                    "parameters": [
                        {
                            "name": "q",
                            "value": "={{ $json.query_text }}"
                        },
                        {
                            "name": "engine",
                            "value": "google"
                        },
                        {
                            "name": "location",
                            "value": "Singapore"
                        },
                        {
                            "name": "google_domain",
                            "value": "google.com.sg"
                        },
                        {
                            "name": "gl",
                            "value": "sg"
                        },
                        {
                            "name": "hl",
                            "value": "en"
                        }
                    ]
                },
                "options": {
                    "timeout": 30000
                }
            },
            "id": "w2-serpapi",
            "name": "SerpAPI Call",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                700,
                300
            ],
            "credentials": {
                "httpQueryAuth": {
                    "id": "serpapi-creds-id",
                    "name": "SerpAPI Key"
                }
            },
            "continueOnFail": true
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO wellness.serp_snapshots (query_id, raw_json, raw_hash)\nVALUES (\n  '{{ $node[\"Split Queries\"].json.id }}'::uuid,\n  '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ $json.search_metadata ? $json.search_metadata.id : \"unknown\" }}'\n)\nRETURNING id;"
            },
            "id": "w2-store-snapshot",
            "name": "Store Snapshot",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                900,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Parse SERP results into structured rows\nconst serp = $node['SerpAPI Call'].json;\nconst snapshot_id = $node['Store Snapshot'].json.id;\nconst vertical_id = $node['Split Queries'].json.vertical_id;\nconst results = [];\n\n// Organic results\nif (serp.organic_results) {\n  for (const r of serp.organic_results) {\n    try {\n      const domain = new URL(r.link).hostname.replace('www.', '');\n      results.push({\n        snapshot_id,\n        rank_position: r.position,\n        block_type: 'organic',\n        title: r.title || '',\n        url: r.link,\n        domain,\n        snippet: r.snippet || '',\n        vertical_id\n      });\n    } catch (e) {}\n  }\n}\n\n// Local pack\nif (serp.local_results && serp.local_results.places) {\n  let pos = 1;\n  for (const r of serp.local_results.places) {\n    const domain = r.website ? new URL(r.website).hostname.replace('www.', '') : null;\n    results.push({\n      snapshot_id,\n      rank_position: pos++,\n      block_type: 'local_pack',\n      title: r.title || '',\n      url: r.website || '',\n      domain,\n      snippet: r.address || '',\n      vertical_id\n    });\n  }\n}\n\nreturn results.map(r => ({ json: r }));"
            },
            "id": "w2-parse-results",
            "name": "Parse Results",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1100,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "-- Upsert domain first\nINSERT INTO wellness.domains (domain, discovery_state)\nVALUES ('{{ $json.domain }}', 'pending')\nON CONFLICT (domain) DO UPDATE SET domain = EXCLUDED.domain\nRETURNING id;"
            },
            "id": "w2-upsert-domain",
            "name": "Upsert Domain",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1300,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            },
            "continueOnFail": true
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO wellness.serp_results (snapshot_id, rank_position, block_type, title, url, domain_id, snippet)\nVALUES (\n  '{{ $node[\"Parse Results\"].json.snapshot_id }}'::uuid,\n  {{ $node[\"Parse Results\"].json.rank_position }},\n  '{{ $node[\"Parse Results\"].json.block_type }}',\n  '{{ ($node[\"Parse Results\"].json.title || \"\").replace(/'/g, \"''\") }}',\n  '{{ $node[\"Parse Results\"].json.url }}',\n  '{{ $json.id }}'::uuid,\n  '{{ ($node[\"Parse Results\"].json.snippet || \"\").replace(/'/g, \"''\") }}'\n)\nON CONFLICT (snapshot_id, rank_position, block_type) DO NOTHING\nRETURNING id;"
            },
            "id": "w2-insert-result",
            "name": "Insert Result",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1500,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "-- Seed clinic if we have a new domain\nINSERT INTO wellness.clinics (name, vertical_id)\nSELECT '{{ ($node[\"Parse Results\"].json.title || \"\").replace(/'/g, \"''\") }}', '{{ $node[\"Parse Results\"].json.vertical_id }}'::uuid\nWHERE NOT EXISTS (\n  SELECT 1 FROM wellness.domains d\n  JOIN wellness.clinics c ON d.clinic_id = c.id\n  WHERE d.id = '{{ $json.id }}'::uuid AND d.clinic_id IS NOT NULL\n)\nRETURNING id;"
            },
            "id": "w2-seed-clinic",
            "name": "Seed Clinic",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1700,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            },
            "continueOnFail": true
        }
    ],
    "connections": {
        "Manual Trigger": {
            "main": [
                [
                    {
                        "node": "Get Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Queries": {
            "main": [
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split Queries": {
            "main": [
                [
                    {
                        "node": "SerpAPI Call",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "SerpAPI Call": {
            "main": [
                [
                    {
                        "node": "Store Snapshot",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Store Snapshot": {
            "main": [
                [
                    {
                        "node": "Parse Results",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Results": {
            "main": [
                [
                    {
                        "node": "Upsert Domain",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upsert Domain": {
            "main": [
                [
                    {
                        "node": "Insert Result",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Insert Result": {
            "main": [
                [
                    {
                        "node": "Seed Clinic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "active": false
}