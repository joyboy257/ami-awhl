{
    "name": "W-2: SERP Pipeline (Serper)",
    "nodes": [
        {
            "parameters": {},
            "id": "w2-trigger",
            "name": "Manual Trigger",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                100,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT sq.id as query_id, sq.vertical_id, sq.query_text, COALESCE(sq.geo, '') as geo\nFROM wellness.search_queries sq\nWHERE sq.active = true AND sq.priority_tier IN ('A', 'B')\nAND NOT EXISTS (SELECT 1 FROM wellness.serp_snapshots ss WHERE ss.query_id = sq.id AND ss.captured_at > NOW() - INTERVAL '24 hours')\nLIMIT 50;"
            },
            "id": "w2-get-queries",
            "name": "Get Queries",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                300,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "id": "w2-split",
            "name": "Split Queries",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                500,
                300
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://google.serper.dev/search",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "X-API-KEY",
                            "value": "YOUR_SERPER_API_KEY"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ JSON.stringify({ q: ($json.query_text || '') + ($json.geo ? ' ' + $json.geo : '') + ' singapore', gl: 'sg', hl: 'en', num: 20 }) }}",
                "options": {
                    "timeout": 30000
                }
            },
            "id": "w2-serper",
            "name": "Serper Search",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                700,
                300
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Parse Serper response and extract domains\nconst serp = $input.item.json;\n\n// Debug: log what we received\nconsole.log('Serper response keys:', Object.keys(serp));\n\nconst results = [];\n\n// Serper uses 'organic' for organic results\nconst organic = serp.organic || serp.organicResults || [];\n// Serper uses 'places' for local pack\nconst places = serp.places || serp.localResults || [];\n\nfunction isValidDomain(d) {\n  if (!d || typeof d !== 'string') return false;\n  const t = d.trim().toLowerCase();\n  return t && t !== 'null' && t !== 'undefined' && t.length >= 4 && t.includes('.');\n}\n\n// Process organic results\nfor (const r of organic) {\n  const link = r.link || r.url || '';\n  if (!link) continue;\n  try {\n    const domain = new URL(link).hostname.replace(/^www\\./, '');\n    if (!isValidDomain(domain)) continue;\n    results.push({\n      rank_position: r.position || results.length + 1,\n      block_type: 'organic',\n      title: String(r.title || '').substring(0, 500),\n      url: link,\n      domain: domain,\n      snippet: String(r.snippet || '').substring(0, 1000)\n    });\n  } catch (e) {\n    console.log('Failed to parse URL:', link, e.message);\n  }\n}\n\n// Process local pack\nlet pos = 1;\nfor (const r of places) {\n  const website = r.website || r.link || '';\n  if (!website) { pos++; continue; }\n  try {\n    const domain = new URL(website).hostname.replace(/^www\\./, '');\n    if (!isValidDomain(domain)) { pos++; continue; }\n    results.push({\n      rank_position: pos,\n      block_type: 'local_pack',\n      title: String(r.title || r.name || '').substring(0, 500),\n      url: website,\n      domain: domain,\n      snippet: String(r.address || '').substring(0, 1000)\n    });\n  } catch (e) {\n    console.log('Failed to parse website:', website, e.message);\n  }\n  pos++;\n}\n\nconsole.log('Parsed results count:', results.length);\n\nif (results.length === 0) {\n  return [{ json: { _skip: true, _debug: 'no_valid_results', _organic_count: organic.length, _places_count: places.length } }];\n}\n\nreturn results.map(r => ({ json: r }));"
            },
            "id": "w2-parse",
            "name": "Parse SERP Results",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                900,
                300
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{ $json._skip !== true && $json.domain && typeof $json.domain === 'string' && $json.domain.length >= 4 && $json.domain.includes('.') }}",
                            "value2": true
                        }
                    ]
                }
            },
            "id": "w2-filter",
            "name": "Filter Valid",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                1100,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO wellness.domains (domain, discovery_state) VALUES ('{{ $json.domain }}', 'pending') ON CONFLICT (domain) DO UPDATE SET domain = EXCLUDED.domain RETURNING id, domain;"
            },
            "id": "w2-upsert-domain",
            "name": "Upsert Domain",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1300,
                250
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            },
            "continueOnFail": true
        },
        {
            "parameters": {},
            "id": "w2-noop",
            "name": "Done",
            "type": "n8n-nodes-base.noOp",
            "typeVersion": 1,
            "position": [
                1500,
                250
            ]
        }
    ],
    "connections": {
        "Manual Trigger": {
            "main": [
                [
                    {
                        "node": "Get Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Queries": {
            "main": [
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split Queries": {
            "main": [
                [
                    {
                        "node": "Serper Search",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Serper Search": {
            "main": [
                [
                    {
                        "node": "Parse SERP Results",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse SERP Results": {
            "main": [
                [
                    {
                        "node": "Filter Valid",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter Valid": {
            "main": [
                [
                    {
                        "node": "Upsert Domain",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upsert Domain": {
            "main": [
                [
                    {
                        "node": "Done",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Done": {
            "main": [
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "active": false
}