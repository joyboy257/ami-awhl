{
    "name": "W-2: SERP Pipeline (Full)",
    "nodes": [
        {
            "parameters": {},
            "id": "w2-trigger",
            "name": "Manual Trigger",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                100,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT sq.id as query_id, sq.vertical_id, sq.query_text, COALESCE(sq.geo, '') as geo\nFROM wellness.search_queries sq\nWHERE sq.active = true AND sq.priority_tier IN ('A', 'B')\nAND NOT EXISTS (SELECT 1 FROM wellness.serp_snapshots ss WHERE ss.query_id = sq.id AND ss.captured_at > NOW() - INTERVAL '24 hours')\nLIMIT 50;"
            },
            "id": "w2-get-queries",
            "name": "Get Queries",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                300,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "id": "w2-split",
            "name": "Split Queries",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                500,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "const q = $input.item.json;\nconst searchQuery = (q.query_text || '') + (q.geo ? ' ' + q.geo : '') + ' singapore';\nreturn [{ json: {\n  query_id: q.query_id,\n  vertical_id: q.vertical_id,\n  _serperBody: { q: searchQuery.trim(), gl: 'sg', hl: 'en', num: 20 }\n}}];"
            },
            "id": "w2-build-request",
            "name": "Build Request",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                650,
                300
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://google.serper.dev/search",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "X-API-KEY",
                            "value": "YOUR_SERPER_API_KEY"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ JSON.stringify($json._serperBody) }}",
                "options": {
                    "timeout": 30000
                }
            },
            "id": "w2-serper",
            "name": "Serper Search",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                850,
                300
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Merge Serper response with query context - KEEP raw JSON for storage\nconst serp = $input.item.json;\nconst buildReq = $node['Build Request'].json;\nconst hash = (serp.searchParameters && serp.searchParameters.q) || 'unknown-' + Date.now();\n\n// Prepare raw_json for storage (stringify the full response, cap at 500KB)\nconst rawJson = JSON.stringify(serp).substring(0, 500000);\n\nreturn [{ json: {\n  query_id: buildReq.query_id,\n  vertical_id: buildReq.vertical_id,\n  _hash: hash,\n  _rawJson: rawJson,\n  organic: serp.organic || [],\n  places: serp.places || []\n}}];"
            },
            "id": "w2-merge-serp",
            "name": "Merge SERP Context",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1050,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO wellness.serp_snapshots (query_id, raw_json, raw_hash)\nVALUES ($1::uuid, $2::jsonb, $3)\nRETURNING id as snapshot_id, query_id;",
                "options": {
                    "queryReplacement": "={{ [$json.query_id, $json._rawJson, $json._hash] }}"
                }
            },
            "id": "w2-store-snapshot",
            "name": "Store Snapshot",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1250,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Merge snapshot ID with SERP data\nconst dbResult = $input.item.json;\nconst mergeSerpData = $node['Merge SERP Context'].json;\nreturn [{ json: {\n  snapshot_id: dbResult.snapshot_id,\n  query_id: dbResult.query_id,\n  vertical_id: mergeSerpData.vertical_id,\n  organic: mergeSerpData.organic,\n  places: mergeSerpData.places\n}}];"
            },
            "id": "w2-merge-snapshot",
            "name": "Merge Snapshot ID",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1450,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// Parse SERP results - extract clinic names from local pack\nconst data = $input.item.json;\nconst snapshot_id = data.snapshot_id;\nconst vertical_id = data.vertical_id;\n\nfunction extractDomain(urlStr) {\n  if (!urlStr) return null;\n  const match = urlStr.match(/^https?:\\/\\/(?:www\\.)?([^\\/:]+)/i);\n  return match ? match[1].toLowerCase() : null;\n}\n\nfunction isValidDomain(d) {\n  if (!d || typeof d !== 'string') return false;\n  const t = d.trim().toLowerCase();\n  return t && t !== 'null' && t !== 'undefined' && t.length >= 4 && t.includes('.');\n}\n\nfunction cleanBusinessName(name) {\n  if (!name) return null;\n  return name\n    .replace(/\\s*[-|Â·].*$/, '')\n    .replace(/\\s+(Pte\\.?\\s*Ltd\\.?|Ltd\\.?|Inc\\.?|LLC|Sdn\\.?\\s*Bhd\\.?)\\s*$/i, '')\n    .trim()\n    .substring(0, 200);\n}\n\nconst results = [];\n\n// Process organic results\nfor (const r of (data.organic || [])) {\n  const domain = extractDomain(r.link || r.url || '');\n  if (isValidDomain(domain)) {\n    results.push({\n      snapshot_id,\n      vertical_id,\n      rank_position: r.position || 0,\n      block_type: 'organic',\n      title: (r.title || '').substring(0, 500),\n      url: r.link || r.url || '',\n      domain,\n      snippet: (r.snippet || '').substring(0, 1000),\n      clinic_name: null,\n      is_local_pack: false\n    });\n  }\n}\n\n// Process local pack (HAS clinic names!)\nlet pos = 1;\nfor (const r of (data.places || [])) {\n  const domain = extractDomain(r.website || r.link || '');\n  const clinicName = cleanBusinessName(r.title || r.name);\n  \n  if (isValidDomain(domain) && clinicName) {\n    results.push({\n      snapshot_id,\n      vertical_id,\n      rank_position: pos,\n      block_type: 'local_pack',\n      title: (r.title || r.name || '').substring(0, 500),\n      url: r.website || r.link || '',\n      domain,\n      snippet: (r.address || '').substring(0, 1000),\n      clinic_name: clinicName,\n      is_local_pack: true\n    });\n  }\n  pos++;\n}\n\nif (results.length === 0) return [{ json: { _skip: true, snapshot_id }}];\nreturn results.map(r => ({ json: r }));"
            },
            "id": "w2-parse",
            "name": "Parse Results",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1650,
                300
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{ $json._skip !== true && $json.domain }}",
                            "value2": true
                        }
                    ]
                }
            },
            "id": "w2-filter",
            "name": "Filter Valid",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                1850,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "-- Create clinic if local pack result with business name\nWITH clinic_upsert AS (\n  INSERT INTO wellness.clinics (name, vertical_id, confidence, first_seen_at)\n  SELECT $1, $2::uuid, 'serp_local_pack', NOW()\n  WHERE $3 = true AND $1 IS NOT NULL AND $1 != ''\n  ON CONFLICT DO NOTHING\n  RETURNING id, name\n),\nclinic_lookup AS (\n  SELECT id FROM wellness.clinics WHERE name = $1\n  UNION ALL\n  SELECT id FROM clinic_upsert\n  LIMIT 1\n),\ndomain_upsert AS (\n  INSERT INTO wellness.domains (domain, clinic_id, discovery_state)\n  SELECT $4, (SELECT id FROM clinic_lookup), 'pending'\n  ON CONFLICT (domain) DO UPDATE SET\n    clinic_id = COALESCE(wellness.domains.clinic_id, (SELECT id FROM clinic_lookup))\n  RETURNING id, clinic_id\n)\nINSERT INTO wellness.serp_results (snapshot_id, rank_position, block_type, title, url, domain_id, snippet)\nSELECT\n  $5::uuid,\n  $6,\n  $7,\n  $8,\n  $9,\n  du.id,\n  $10\nFROM domain_upsert du\nON CONFLICT (snapshot_id, rank_position, block_type) DO NOTHING\nRETURNING id;",
                "options": {
                    "queryReplacement": "={{ [$json.clinic_name, $json.vertical_id, $json.is_local_pack, $json.domain, $json.snapshot_id, $json.rank_position, $json.block_type, ($json.title || '').replace(/'/g, \"''\"), $json.url, ($json.snippet || '').replace(/'/g, \"''\")] }}"
                }
            },
            "id": "w2-upsert-all",
            "name": "Upsert Clinic, Domain & Result",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                2050,
                250
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            },
            "continueOnFail": true
        },
        {
            "parameters": {},
            "id": "w2-noop",
            "name": "Done",
            "type": "n8n-nodes-base.noOp",
            "typeVersion": 1,
            "position": [
                2250,
                300
            ]
        }
    ],
    "connections": {
        "Manual Trigger": {
            "main": [
                [
                    {
                        "node": "Get Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Queries": {
            "main": [
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split Queries": {
            "main": [
                [
                    {
                        "node": "Build Request",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Build Request": {
            "main": [
                [
                    {
                        "node": "Serper Search",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Serper Search": {
            "main": [
                [
                    {
                        "node": "Merge SERP Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge SERP Context": {
            "main": [
                [
                    {
                        "node": "Store Snapshot",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Store Snapshot": {
            "main": [
                [
                    {
                        "node": "Merge Snapshot ID",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Snapshot ID": {
            "main": [
                [
                    {
                        "node": "Parse Results",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Results": {
            "main": [
                [
                    {
                        "node": "Filter Valid",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter Valid": {
            "main": [
                [
                    {
                        "node": "Upsert Clinic, Domain & Result",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upsert Clinic, Domain & Result": {
            "main": [
                [
                    {
                        "node": "Done",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Done": {
            "main": [
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "active": false
}