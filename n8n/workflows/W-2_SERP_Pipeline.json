{
    "name": "W-2: SERP Pipeline",
    "nodes": [
        {
            "parameters": {},
            "id": "w2-trigger-1",
            "name": "Manual Trigger",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                100,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT sq.id, sq.vertical_id, sq.query_text, COALESCE(sq.geo, '') as geo, sq.intent_tag\nFROM wellness.search_queries sq\nWHERE sq.active = true\n  AND sq.priority_tier IN ('A', 'B')\n  AND NOT EXISTS (\n    SELECT 1 FROM wellness.serp_snapshots ss\n    WHERE ss.query_id = sq.id\n      AND ss.captured_at > NOW() - INTERVAL '24 hours'\n  )\nLIMIT 50;"
            },
            "id": "w2-get-queries",
            "name": "Get Queries",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                300,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "id": "w2-split",
            "name": "Split Queries",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                500,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "const q = $input.item.json;\nlet searchQuery = q.query_text || '';\nif (q.geo && q.geo.trim() !== '') {\n  searchQuery += ' ' + q.geo;\n}\nsearchQuery += ' singapore';\nreturn [{ json: { ...q, _search_query: searchQuery.trim() }}];"
            },
            "id": "w2-build-query",
            "name": "Build Query",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                600,
                300
            ]
        },
        {
            "parameters": {
                "engine": "google",
                "q": "={{ $json._search_query }}",
                "location": "Singapore",
                "google_domain": "google.com.sg",
                "gl": "sg",
                "hl": "en",
                "options": {}
            },
            "id": "w2-serpapi-node",
            "name": "SerpApi Node",
            "type": "n8n-nodes-base.serpApi",
            "typeVersion": 1,
            "position": [
                800,
                300
            ],
            "credentials": {
                "serpApi": {
                    "id": "serpapi-creds-id",
                    "name": "SerpAPI Key"
                }
            },
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "const query = $node['Build Query'].json;\nconst serp = $input.item.json;\nconst rawJson = JSON.stringify(serp);\nreturn [{ json: {\n  _query_id: query.id,\n  _vertical_id: query.vertical_id,\n  _geo: query.geo || '',\n  _raw_json: rawJson,\n  _raw_hash: serp.search_metadata ? serp.search_metadata.id : 'unknown',\n  organic_results: serp.organic_results || [],\n  local_results: serp.local_results || null\n}}];"
            },
            "id": "w2-enrich-serp",
            "name": "Enrich SERP",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1000,
                300
            ]
        },
        {
            "parameters": {
                "operation": "insert",
                "schema": {
                    "mode": "list",
                    "value": "wellness"
                },
                "table": {
                    "mode": "list",
                    "value": "serp_snapshots"
                },
                "columns": {
                    "mappingMode": "defineBelow",
                    "value": {
                        "query_id": "={{ $json._query_id }}",
                        "raw_hash": "={{ $json._raw_hash }}"
                    }
                },
                "options": {
                    "returnValues": true
                }
            },
            "id": "w2-store-snapshot",
            "name": "Store Snapshot",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1200,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const dbResult = $input.item.json;\nconst enriched = $node['Enrich SERP'].json;\nconst snapshot_id = dbResult.id;\nconst vertical_id = enriched._vertical_id;\nconst results = [];\n\nfunction isValidDomain(d) {\n  if (!d || typeof d !== 'string') return false;\n  const trimmed = d.trim().toLowerCase();\n  if (!trimmed || trimmed === 'null' || trimmed === 'undefined') return false;\n  if (trimmed.length < 4 || !trimmed.includes('.')) return false;\n  return true;\n}\n\nif (enriched.organic_results && enriched.organic_results.length > 0) {\n  for (const r of enriched.organic_results) {\n    try {\n      const domain = new URL(r.link).hostname.replace('www.', '');\n      if (!isValidDomain(domain)) continue;\n      results.push({ snapshot_id, rank_position: r.position || 0, block_type: 'organic', title: (r.title || '').substring(0, 500), url: r.link || '', domain, snippet: (r.snippet || '').substring(0, 1000), vertical_id });\n    } catch (e) {}\n  }\n}\n\nif (enriched.local_results && enriched.local_results.places) {\n  let pos = 1;\n  for (const r of enriched.local_results.places) {\n    let domain = null;\n    if (r.website) { try { domain = new URL(r.website).hostname.replace('www.', ''); } catch(e) {} }\n    if (isValidDomain(domain)) {\n      results.push({ snapshot_id, rank_position: pos, block_type: 'local_pack', title: (r.title || '').substring(0, 500), url: r.website || '', domain, snippet: (r.address || '').substring(0, 1000), vertical_id });\n    }\n    pos++;\n  }\n}\n\nif (results.length === 0) return [{ json: { _skip: true, snapshot_id } }];\nreturn results.map(r => ({ json: r }));"
            },
            "id": "w2-parse-results",
            "name": "Parse Results",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1400,
                300
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{ $json._skip !== true && $json.domain && $json.domain.length >= 4 }}",
                            "value2": true
                        }
                    ]
                }
            },
            "id": "w2-filter-valid",
            "name": "Filter Valid",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                1600,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO wellness.domains (domain, discovery_state) VALUES ('{{ $json.domain }}', 'pending') ON CONFLICT (domain) DO UPDATE SET domain = EXCLUDED.domain RETURNING id;"
            },
            "id": "w2-upsert-domain",
            "name": "Upsert Domain",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1800,
                250
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            },
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "const domainResult = $input.item.json;\nconst parseData = $node['Parse Results'].json;\nreturn [{ json: { ...parseData, domain_id: domainResult.id } }];"
            },
            "id": "w2-merge-domain",
            "name": "Merge Domain ID",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2000,
                250
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO wellness.serp_results (snapshot_id, rank_position, block_type, title, url, domain_id, snippet) VALUES ('{{ $json.snapshot_id }}'::uuid, {{ $json.rank_position }}, '{{ $json.block_type }}', '{{ ($json.title || \"\").replace(/'/g, \"''\").substring(0, 500) }}', '{{ $json.url }}', '{{ $json.domain_id }}'::uuid, '{{ ($json.snippet || \"\").replace(/'/g, \"''\").substring(0, 1000) }}') ON CONFLICT (snapshot_id, rank_position, block_type) DO NOTHING RETURNING id;"
            },
            "id": "w2-insert-result",
            "name": "Insert Result",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                2200,
                250
            ],
            "credentials": {
                "postgres": {
                    "id": "postgres-creds-id",
                    "name": "Postgres account"
                }
            },
            "continueOnFail": true
        }
    ],
    "connections": {
        "Manual Trigger": {
            "main": [
                [
                    {
                        "node": "Get Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Queries": {
            "main": [
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split Queries": {
            "main": [
                [
                    {
                        "node": "Build Query",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Build Query": {
            "main": [
                [
                    {
                        "node": "SerpApi Node",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "SerpApi Node": {
            "main": [
                [
                    {
                        "node": "Enrich SERP",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Enrich SERP": {
            "main": [
                [
                    {
                        "node": "Store Snapshot",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Store Snapshot": {
            "main": [
                [
                    {
                        "node": "Parse Results",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Results": {
            "main": [
                [
                    {
                        "node": "Filter Valid",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter Valid": {
            "main": [
                [
                    {
                        "node": "Upsert Domain",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upsert Domain": {
            "main": [
                [
                    {
                        "node": "Merge Domain ID",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Domain ID": {
            "main": [
                [
                    {
                        "node": "Insert Result",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Insert Result": {
            "main": [
                [
                    {
                        "node": "Split Queries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "active": false
}